<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Facilities Map</title>
    <!-- æ·»åŠ  Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map {
            height: 600px;
            width: 100%;
            margin: 20px 0;
            z-index: 1;
        }
        .custom-zoom-control {
            background-color: white;
            padding: 5px;
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.65);
        }
        .location-button {
            background-color: white;
            width: 30px;
            height: 30px;
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        .location-button:hover {
            background-color: #f4f4f4;
        }
    </style>
    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <header>
        <button class="back-button" onclick="goBack()">Back</button>
        <h1>Health Facilities Near You</h1>
    </header>
  
    <div class="controls">
        <input id="search-input" type="text" placeholder="Search for health facilities...">
        <button onclick="searchFacilities()">Search</button>
    </div>

    <div id="map"></div>

    <!-- æ·»åŠ  Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let markers = [];
        let facilityMarkers = {};

        // Firebase configuration
        const firebaseConfig = {
            // Replace with your Firebase config
            apiKey: "your-api-key",
            authDomain: "your-auth-domain",
            projectId: "your-project-id",
            storageBucket: "your-storage-bucket",
            messagingSenderId: "your-messaging-sender-id",
            appId: "your-app-id"
        };

//      firebase data   {
//     name: "New Clinic",
//     lat: 52.1332,
//     lng: -106.6700,
//     address: "123 Main St",
//     phone: "306-123-4567",
//     description: "24/7 Emergency Care"
// }

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        function initMap() {
            const SASKATOON_CENTER = {
                lat: 52.1332,
                lng: -106.6700
            };
            
            // åˆå§‹åŒ–åœ°å›¾ï¼Œæ·»åŠ ç¼©æ”¾æ§ä»¶
            map = L.map('map', {
                center: [SASKATOON_CENTER.lat, SASKATOON_CENTER.lng],
                zoom: 13,
                zoomControl: false // ç¦ç”¨é»˜è®¤ç¼©æ”¾æ§ä»¶
            });
            
            // æ·»åŠ åœ°å›¾å›¾å±‚
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            // æ·»åŠ è‡ªå®šä¹‰ç¼©æ”¾æ§ä»¶
            L.control.zoom({
                position: 'topright',
                zoomInText: '+',
                zoomOutText: '-',
                zoomInTitle: 'Zoom in',
                zoomOutTitle: 'Zoom out'
            }).addTo(map);

            // æ·»åŠ å®šä½æŒ‰é’®
            const locationControl = L.control({position: 'topright'});
            locationControl.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'location-button');
                div.innerHTML = 'ğŸ“';
                div.title = 'Show my location';
                div.onclick = function() {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                const lat = position.coords.latitude;
                                const lng = position.coords.longitude;
                                map.setView([lat, lng], 15);
                                
                                // æ·»åŠ æˆ–æ›´æ–°ç”¨æˆ·ä½ç½®æ ‡è®°
                                if (window.userMarker) {
                                    map.removeLayer(window.userMarker);
                                }
                                window.userMarker = L.marker([lat, lng])
                                    .addTo(map)
                                    .bindPopup('You are here')
                                    .openPopup();
                            },
                            () => {
                                alert("Could not get your location");
                            }
                        );
                    } else {
                        alert("Geolocation is not supported by your browser");
                    }
                };
                return div;
            };
            locationControl.addTo(map);

            // æ·»åŠ  Saskatoon ä¸­å¿ƒæ ‡è®°
            L.marker([SASKATOON_CENTER.lat, SASKATOON_CENTER.lng])
                .addTo(map)
                .bindPopup('Saskatoon City Center')
                .openPopup();

            initRealTimeUpdates();
        }

        function initRealTimeUpdates() {
            // ç›‘å¬ facilities é›†åˆçš„å˜åŒ–
            db.collection("facilities").onSnapshot((snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const facility = change.doc.data();
                    const facilityId = change.doc.id;

                    if (change.type === "added" || change.type === "modified") {
                        // æ·»åŠ æˆ–æ›´æ–°æ ‡è®°
                        if (facilityMarkers[facilityId]) {
                            // æ›´æ–°ç°æœ‰æ ‡è®°
                            map.removeLayer(facilityMarkers[facilityId]);
                        }
                        
                        // åˆ›å»ºæ–°æ ‡è®°
                        const marker = L.marker([facility.lat, facility.lng])
                            .addTo(map)
                            .bindPopup(`
                                <b>${facility.name}</b><br>
                                ${facility.address || ''}<br>
                                ${facility.phone || ''}<br>
                                ${facility.description || ''}
                            `);
                        
                        facilityMarkers[facilityId] = marker;

                    } else if (change.type === "removed") {
                        // åˆ é™¤æ ‡è®°
                        if (facilityMarkers[facilityId]) {
                            map.removeLayer(facilityMarkers[facilityId]);
                            delete facilityMarkers[facilityId];
                        }
                    }
                });
            }, (error) => {
                console.error("Error listening to facility updates:", error);
            });
        }

        // ä¿®æ”¹æœç´¢å‡½æ•°ä»¥ä½¿ç”¨å®æ—¶æ•°æ®
        function searchFacilities() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            // éšè—æ‰€æœ‰æ ‡è®°
            Object.values(facilityMarkers).forEach(marker => {
                map.removeLayer(marker);
            });

            // åªæ˜¾ç¤ºåŒ¹é…çš„æ ‡è®°
            db.collection("facilities")
                .get()
                .then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        const facility = doc.data();
                        if (facility.name.toLowerCase().includes(searchTerm)) {
                            facilityMarkers[doc.id].addTo(map);
                        }
                    });
                })
                .catch((error) => {
                    console.error("Error searching facilities:", error);
                });
        }

        function goBack() {
            window.history.back();
        }

        // åˆå§‹åŒ–åœ°å›¾
        window.onload = initMap;
    </script>
</body>
</html>